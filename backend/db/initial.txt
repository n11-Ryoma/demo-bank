-- 1) アプリ用ユーザー作成（パスワードは任意に変更）
CREATE USER bank_user WITH PASSWORD 'bank_pass';

-- 2) DB作成（オーナーをアプリユーザーに）
CREATE DATABASE bank_app OWNER bank_user;

-- 3) 権限（基本はオーナーなので不要だが明示）
GRANT ALL PRIVILEGES ON DATABASE bank_app TO bank_user;
-- psqlなら：
-- \c bank_app bank_user
BEGIN;

-- users（テスト用：平文パスワード）
CREATE TABLE IF NOT EXISTS users (
  id           BIGSERIAL PRIMARY KEY,
  username     VARCHAR(64) NOT NULL UNIQUE,
  password     TEXT NOT NULL,                 -- テスト限定（平文）
  email        VARCHAR(254),
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- accounts（1ユーザー1口座：user_id UNIQUE）
CREATE TABLE IF NOT EXISTS accounts (
  id             BIGSERIAL PRIMARY KEY,
  user_id        BIGINT NOT NULL UNIQUE REFERENCES users(id) ON DELETE RESTRICT,
  branch_code    VARCHAR(8) NOT NULL,
  account_number VARCHAR(16) NOT NULL,
  balance        BIGINT NOT NULL DEFAULT 0,     -- JPY想定
  opened_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (branch_code, account_number)
);

CREATE INDEX IF NOT EXISTS idx_accounts_user_id ON accounts(user_id);

-- transactions
CREATE TABLE IF NOT EXISTS transactions (
  id                    BIGSERIAL PRIMARY KEY,
  account_id             BIGINT NOT NULL REFERENCES accounts(id) ON DELETE RESTRICT,

  type                  VARCHAR(16) NOT NULL,  -- 'DEPOSIT','WITHDRAWAL','TRANSFER_IN','TRANSFER_OUT',...
  amount                BIGINT NOT NULL CHECK (amount >= 0),
  balance_after         BIGINT NOT NULL,

  description           TEXT,
  related_branch_code    VARCHAR(8),
  related_account_number VARCHAR(16),

  created_at            TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 一覧表示・ページング用
CREATE INDEX IF NOT EXISTS idx_tx_account_created
  ON transactions(account_id, created_at DESC, id DESC);

-- relatedAccountNumber検索用
CREATE INDEX IF NOT EXISTS idx_tx_related_accnum
  ON transactions(related_account_number);

-- description検索（簡易）
CREATE INDEX IF NOT EXISTS idx_tx_desc_gin
  ON transactions USING GIN (to_tsvector('simple', coalesce(description,'')));

COMMIT;
INSERT INTO users (username, password, email)
VALUES ('admin', 'adminpass', 'admin@example.com')
RETURNING id;

-- 返ってきた id を使って accounts を作る（例では user_id=1 と仮定）
INSERT INTO accounts (user_id, branch_code, account_number, balance)
VALUES (1, '001', '1234567', 100000)
RETURNING id;
-- 例では account_id=1 と仮定
INSERT INTO transactions
(account_id, type, amount, balance_after, description, related_branch_code, related_account_number)
VALUES
(1, 'WITHDRAWAL', 5000, 95000, 'コンビニATM', NULL, NULL),
(1, 'TRANSFER_OUT', 12000, 83000, '振込', '002', '7654321');
CREATE TABLE IF NOT EXISTS address_change_requests (
  id              BIGSERIAL PRIMARY KEY,

  user_id         BIGINT NOT NULL REFERENCES users(id) ON DELETE RESTRICT,

  postal_code     VARCHAR(16)  NOT NULL,
  prefecture      VARCHAR(64)  NOT NULL,
  city            VARCHAR(128) NOT NULL,
  address_line1   VARCHAR(255) NOT NULL,
  address_line2   VARCHAR(255),

  proof_file_path TEXT,
  proof_file_data BYTEA,                 -- byte[] に対応

  status          VARCHAR(16) NOT NULL,  -- 'PENDING' など
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 最新1件取得を速くする（findLatest...に効く）
CREATE INDEX IF NOT EXISTS idx_addr_req_user_created
  ON address_change_requests(user_id, created_at DESC);
CREATE TABLE IF NOT EXISTS user_profile (
  user_id        BIGINT PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  name_kanji     VARCHAR(128) NOT NULL,
  name_kana      VARCHAR(128),
  birth_date     DATE NOT NULL,
  gender         VARCHAR(16),
  phone          VARCHAR(32) NOT NULL,
  postal_code    VARCHAR(16),
  address        TEXT NOT NULL,
  my_number      VARCHAR(32)  -- テスト用（本来は平文NG）
);
